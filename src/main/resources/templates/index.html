<html>
<head>
    <meta charset="UTF-8">
    <title>Tabletop Calendar</title>
    <script src="main.js"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.9/auth0-spa-js.production.js"></script>
</head>

<style>
    .hidden {
        display: none;
    }

    label {
        margin-bottom: 10px;
        display: block;
    }
</style>

<body>
<h2> Tabletop calendar</h2>

<button id="btn-login" disabled="true" onclick="login()">Log in</button>
<button id="btn-logout" disabled="true" onclick="logout()">Log out</button>


<div id="tabletopCalendarWebApp"></div>

<script>
    let auth0 = null;
    const fetchAuthConfig = () => fetch("/auth_config.json");

    const configureClient = async () => {
        const response = await fetchAuthConfig();
        const config = await response.json();

        auth0 = await createAuth0Client({
            domain: config.domain,
            client_id: config.clientId,
            audience: config.audience
        });
    };

    window.onload = async () => {
        await configureClient();
        updateUI();
        const isAuthenticated = await auth0.isAuthenticated();
        if (isAuthenticated) {
            return;
        }
        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {
            await auth0.handleRedirectCallback();
            updateUI();
            window.history.replaceState({}, document.title, "/");
        }
    }

    const updateUI = async () => {
        const isAuthenticated = await auth0.isAuthenticated();

        document.getElementById("btn-logout").disabled = !isAuthenticated;
        document.getElementById("btn-login").disabled = isAuthenticated;
        document.getElementById("tabletopCalendarWebApp").disabled = !isAuthenticated;

        if (isAuthenticated) {
            const token = await auth0.getTokenSilently();
            const bearerToken = "Bearer " + token;
            console.log(bearerToken)
            const app = Elm.Main.init({
                node: document.getElementById('tabletopCalendarWebApp'),
                flags: bearerToken
            });
        }
    };

    const login = async () => {
        await auth0.loginWithRedirect({
            redirect_uri: window.location.origin
        });
    };

    const logout = () => {
        auth0.logout({
            returnTo: window.location.origin
        });
    };


</script>
</body>
</html>
